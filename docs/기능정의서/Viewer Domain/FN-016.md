FN-016: Highlight & Annotation System
- Purpose / Value – Enable active reading with notes and highlights
- Scope / Module – features/viewer/services/annotation_service
- Primary Actor(s) – User, Reader View
- Triggers –
  - Text selection
  - Highlight button tap
  - Note creation
- Inputs –
  - Selected text (String)
  - Selection range (TextRange)
  - Color choice (Color)
  - Note text (String?)
- Processing Logic –
  1. Capture text selection
  2. Calculate position
  3. Show annotation menu
  4. Create highlight object
  5. Optional note input
  6. Save to database
  7. Update UI instantly
  8. Sync if enabled
- Outputs –
  - Annotation object
  - Updated view
  - Sync status
- Business Rules & Constraints –
  - Max 100 highlights/content
  - Note max 500 chars
  - 5 color options
  - No overlapping highlights
- Error Handling & Edge Cases –
  - Selection across elements → Merge
  - Save failure → Queue for retry
  - Sync conflict → Latest wins
  - Delete undo → 5s window
- Data Model Touchpoints –
  - annotations (CRUD)
  - annotation_sync (CREATE)
- API Endpoints / Methods –
  - POST /api/annotations
  - DELETE /api/annotations/:id
- Permissions / Security – User annotations only
- Performance / SLA Notes – Instant feedback
- UX References –
  - HighlightPopover
  - NoteEditor
  - AnnotationList
- Dependencies –
  - selection_controls: ^0.1.0
- Acceptance Criteria –
  - Precise selection
  - Instant save
  - Color coding
  - Export support
- Code Pointers –
  - lib/features/viewer/services/annotation_service.dart
  - lib/features/viewer/widgets/highlight_overlay.dart